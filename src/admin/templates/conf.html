<!DOCTYPE html>
<html lang="en">

  {{ template "head" . }}

  <body class="app header-fixed sidebar-fixed aside-menu-fixed sidebar-lg-show">
    
    {{ template "page-header" . }}
    
    <div class="app-body">
      
      {{ template "page-sidebar" . }}
      
      <main class="main">
        
        <div class="container-fluid">
          
          <div class="animated fadeIn">

            <div class="card mt-2">
              <div class="card-header">
                <i class="fa fas fa-server"></i> osquery configuration for context {{ .Context }}
                <div class="card-header-actions">
                  <div class="card-header-action">
                    <button id="json_save" class="btn btn-sm btn-block btn-dark" 
                      data-toggle="tooltip" data-placement="bottom" title="Save Changes" onclick="saveConfiguration();">
                      <i class="far fa-save"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                
                <input type="hidden" id="csrftoken" value="">

                <textarea id="conf" name="conf">{{ .ConfigurationBlob }}</textarea>
                <div class="row">
                  <div class="col-md-12">
                    <button id="json_status_color" class="text-left btn btn-sm btn-square btn-block btn-success disabled">
                      <span id="json_status_icon" class="mr-2"><i class="fas fa-check"></i></span>
                      <span id="json_status_text" class="ml-1">Valid JSON</span>
                    </button>
                  </div>
                </div>

              </div>
            </div>

            <div class="card mt-2">
              <div class="card-header">
                  <i class="fas fa-bolt"></i> osctrl quick install/update nodes for context {{ .Context }}
              </div>
              <div class="card-body">

                <div class="row mb-4">
                  <div class="col-md-12">
                    Run this command in Linux or Mac to quickly add/update nodes in the context {{ .Context }}. It will install osquery in the system:
                  </div>
                </div>
                <div class="row mb-4">
                  <div class="col-md-12">
                    <button id="button-clipboard-sh" class="btn-sm btn-clipboard" data-clipboard-action="copy" data-clipboard-target="#osctrl-enroll-cmd-sh">
                      Copy
                    </button>
                    <div class="highlight">
                      <code id="osctrl-enroll-cmd-sh" class="bash">
                        {{ .QuickAddShell }}
                      </code>
                    </div>
                  </div>
                </div>

                <div class="row mb-4">
                  <div class="col-md-12">
                    Run this command in Windows to quickly add nodes in the context {{ .Context }}. It will install osquery in the system:
                  </div>
                </div>
                <div class="row mb-4">
                  <div class="col-md-12">
                    <button id="button-clipboard-ps" class="btn-sm btn-clipboard" data-clipboard-action="copy" data-clipboard-target="#osctrl-enroll-cmd-ps">
                      Copy
                    </button>
                    <div class="highlight">
                      <code id="osctrl-enroll-cmd-ps" class="bash">
                        {{ .QuickAddPowershell }}
                      </code>
                    </div>
                  </div>
                </div>
              
              </div>
            </div>

            <div class="card mt-2">
              <div class="card-header">
                <i class="fas fa-exclamation-triangle"></i> osctrl quick <span style="color:red;">remove</span> nodes for context {{ .Context }}
              </div>
              <div class="card-body">

                <div class="row mb-4">
                  <div class="col-md-12">
                    Run this command in Linux or Mac to quickly <span style="color:red;">remove</span> nodes in the context {{ .Context }}. It will NOT remove osquery from the system:
                  </div>
                </div>
                <div class="row mb-4">
                  <div class="col-md-12">
                    <button id="button-clipboard-sh" class="btn-sm btn-clipboard" data-clipboard-action="copy" data-clipboard-target="#osctrl-remove-cmd-sh">
                      Copy
                    </button>
                    <div class="highlight">
                      <code id="osctrl-remove-cmd-sh" class="bash">
                        {{ .QuickRemoveShell }}
                      </code>
                    </div>
                  </div>
                </div>

                <div class="row mb-4">
                  <div class="col-md-12">
                    Run this command in Windows to quickly <span style="color:red;">remove</span> nodes in the context {{ .Context }}. It will NOT remove osquery from the system:
                  </div>
                </div>
                <div class="row mb-4">
                  <div class="col-md-12">
                    <button id="button-clipboard-ps" class="btn-sm btn-clipboard" data-clipboard-action="copy" data-clipboard-target="#osctrl-remove-cmd-ps">
                      Copy
                    </button>
                    <div class="highlight">
                      <code id="osctrl-remove-cmd-ps" class="bash">
                        {{ .QuickRemovePowershell }}
                      </code>
                    </div>
                  </div>
                </div>
              
              </div>
            </div>

            <div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-success" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="modal-title">Completed successfully</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <p id="successModalMessage"></p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                  </div>
                </div>
                <!-- /.modal-content -->
              </div>
              <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->

            <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-danger" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="modal-title">Something went wrong...</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <p id="errorModalMessageClient"></p>
                    <p id="errorModalMessageServer"></p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  </div>
                </div>
                <!-- /.modal-content -->
              </div>
              <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->

        </div>

      </main>
      
      {{ template "page-aside" . }}
      
    </div>

    <!-- Bootstrap: jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <!-- CoreUI JS -->
    <script src="/static/js/coreui.min.js"></script>
    <!-- Codemirror JS -->
    <script src="/static/js/codemirror/codemirror.js"></script>
    <script src="/static/js/codemirror/addon/active-line.js"></script>
    <script src="/static/js/codemirror/addon/matchbrackets.js"></script>
    <script src="/static/js/codemirror/mode/javascript.js"></script>
    <!-- Clipboard.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js" integrity="sha384-5tfO0soa+FisnuBhaHP2VmPXQG/JZ8dLcRL43IkJFzbsXTXT6zIX8q8sIT0VSe2G" crossorigin="anonymous"></script>
    <!-- Highlight.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js" integrity="sha384-BlPof9RtjBqeJFskKv3sK3dh4Wk70iKlpIe92FeVN+6qxaGUOUu+mZNpALZ+K7ya" crossorigin="anonymous"></script>
    <!-- osctrl JS -->
    <script src="/static/js/functions.js"></script>
    <script src="/static/js/settings.js"></script>
    <script src="/static/js/login.js"></script>
    <script src="/static/js/configuration.js"></script>
    <script type="text/javascript">
      // Highlight.js initialization
      hljs.initHighlightingOnLoad();
      $(document).ready(function() {
        // Codemirror editor for configuration
        // JSON validity check when content is changed
        var editorConf = CodeMirror.fromTextArea(document.getElementById("conf"), {
          lineNumbers: true,
          styleActiveLine: true,
          matchBrackets: true,
          readOnly: false
        });
        $('#conf').data('CodeMirrorInstance', editorConf);
        editorConf.on('change', function(_editor){
          var _valid = true;
          try {
            JSON.parse(_editor.getValue());
          } catch (e) {
            // Display error in console
            console.log(e);
            // Display error in status
            var _position = e.toString().split('position ')[1];
            $("#json_status_text").text('Invalid JSON - ' +e+' ('+lineCharPosition(_position)+')');
            $("#json_status_icon").html('<i class="fas fa-times"></i>');
            $("#json_status_color").each(function(){
              $(this).removeClass("btn-success");
              $(this).addClass("btn-danger");
            });
            _valid = false
            // Disable button
            $('#json_save').prop("disabled", true);
            // Position cursor in where the problem is at
          }
          if (_valid) {
            $("#json_status_text").text('Valid JSON');
            $("#json_status_icon").html('<i class="fas fa-check"></i>');
            $("#json_status_color").each(function(){
              $(this).removeClass("btn-danger");
              $(this).addClass("btn-success");
            });
            $('#json_save').prop("disabled", false);
          }
        });
        editorConf.setSize("100%", "100%");

        // Highlight.js initialization
        $('code').each(function(i, block) {
          hljs.highlightBlock(block);
        });

        // Enable all tooltips
        $('[data-toggle="tooltip"]').tooltip({trigger : 'hover'});

        // Clipboard.js initialization
        var clipboard_sh = new ClipboardJS('#button-clipboard-sh');
        clipboard_sh.on('success', function(e) {
          console.info('Action:', e.action);
          console.info('Text:', e.text);
          console.info('Trigger:', e.trigger);
          $(e.trigger).text('Copied!');
          e.clearSelection();
          setTimeout(function() {
            $(e.trigger).text('Copy');
          }, 2500);
        });
        clipboard_sh.on('error', function(e) {
          $(e.trigger).text('Error');
          console.error('Action:', e.action);
          console.error('Trigger:', e.trigger);
        });
        var clipboard_ps = new ClipboardJS('#button-clipboard-ps');
        clipboard_ps.on('success', function(e) {
          console.info('Action:', e.action);
          console.info('Text:', e.text);
          console.info('Trigger:', e.trigger);
          $(e.trigger).text('Copied!');
          e.clearSelection();
          setTimeout(function() {
            $(e.trigger).text('Copy');
          }, 2500);
        });
        clipboard_ps.on('error', function(e) {
          $(e.trigger).text('Error');
          console.error('Action:', e.action);
          console.error('Trigger:', e.trigger);
        });
      });
    </script>
  </body>
</html>